## 总体目标
- 依据 A.md 规范，完成登录/注册/验证码/会话接口，并实现完整的用户管理与角色管理（含菜单与权限的基础结构）。
- 前后端契约统一：路径、请求/响应 DTO、鉴权策略一致；所有数据持久化到 MySQL。
- 保留现有 sa-token 方案，扩展为 RBAC 权限校验，后续可支持 `Authorization: Bearer` 风格。

## 技术选型
- 后端：Spring Boot 3、sa-token、MyBatis-Plus（加速 CRUD）、Flyway（数据库迁移）、MySQL 8。
- 前端：Vite + React + Ant Design + @ant-design/pro-components、Axios。

## 接口约定（统一路径与权限）
- 认证模块（匿名访问）：
  - `POST /api/auth/login` ← `LoginRequest` → `{ token: string, user: UserDto }`
  - `GET /api/auth/captcha` → `CaptchaResponse`
  - `POST /api/auth/register` ← `RegisterRequest` → `{ id }`（新增）
  - `POST /api/auth/logout`（需权限：`sys:auth:session`）
  - `GET /api/auth/me` → `UserDto`（需权限：`sys:auth:session`）
- 个人资料：
  - `GET /api/profile`、`PUT /api/profile`、`PUT /api/profile/password`、`PUT /api/profile/avatar`、`PUT /api/profile/tags`
- 用户管理（后台）：
  - `GET /api/admin/users`、`GET /api/admin/users/{id}`、`POST /api/admin/users`、`PUT /api/admin/users/{id}`、`DELETE /api/admin/users/{id}`
  - `PUT /api/admin/users/{id}/status`、`PUT /api/admin/users/{id}/reset-password`、`PUT /api/admin/users/{id}/roles`
  - `POST /api/admin/users/import`、`GET /api/admin/users/export`
- 角色管理（后台）：
  - `GET /api/admin/roles`、`GET /api/admin/roles/{id}`、`POST /api/admin/roles`、`PUT /api/admin/roles/{id}`、`DELETE /api/admin/roles/{id}`
  - `PUT /api/admin/roles/{id}/menus`、`PUT /api/admin/roles/{id}/permissions`
- 菜单管理（后台）：
  - `GET /api/admin/menus/tree`、`GET /api/admin/menus/{id}`、`POST /api/admin/menus`、`PUT /api/admin/menus/{id}`、`DELETE /api/admin/menus/{id}`、（可选）`PUT /api/admin/menus/{id}/permissions`
- 权限（动作）管理（后台）：
  - `GET/POST/PUT/DELETE /api/admin/permissions` 及详情接口

## DTO 对齐（来自 A.md）
- `LoginRequest`：`username`、`password`、`captchaToken?`、`captchaCode?`
- `CaptchaResponse`：`captchaToken`、`imageBase64`、`expireInSeconds`
- `UserDto`：包含基本信息、`roles: RoleBrief[]`、`permissions: string[]`、`status`、`presenceStatus`、`createdAt`
- 分页响应 `Page<T>`：`records,total,page,size`
- 其余 Request/Item/Detail DTO 按 A.md 字段表实现（用户、角色、菜单、权限）。

## 鉴权策略
- sa-token 登录 `loginId = userId`；除登录/注册/验证码外，其余均鉴权。
- 管理端接口使用 `@SaCheckPermission("sys:xxx:action")` 粒度控制；登录后返回 `permissions` 供前端按钮显隐。
- 前端请求头：默认使用 `satoken: <token>`（与 sa-token 保持兼容），计划增加兼容 `Authorization: Bearer <token>`（后端拦截器解析）。

## 数据库设计（MySQL，`acc`）
- 用户与认证：
  - `sys_user`：`id BIGINT PK AI`、`username VARCHAR(64) UNIQUE`、`password_hash VARCHAR(255)`、`name VARCHAR(100)`、`nickname VARCHAR(100)`、`gender TINYINT`、`email VARCHAR(255)`、`phone VARCHAR(30)`、`avatar_url VARCHAR(512)`、`address VARCHAR(255)`、`bio TEXT`、`tags JSON`、`status TINYINT`、`presence_status TINYINT`、`created_at DATETIME`、`updated_at DATETIME`
  - `sys_user_role`：`user_id BIGINT`、`role_id BIGINT`（联合唯一），索引各字段
- 角色与权限：
  - `sys_role`：`id BIGINT PK AI`、`role_name VARCHAR(50)`、`role_code VARCHAR(50) UNIQUE`、`description VARCHAR(255)`、`status TINYINT`、`created_at/updated_at`
  - `sys_permission`：`id BIGINT PK AI`、`perm_code VARCHAR(100) UNIQUE`、`perm_name VARCHAR(100)`、`perm_type TINYINT`、`resource VARCHAR(100)`、`action VARCHAR(50)`、`http_method VARCHAR(10)`、`http_path VARCHAR(255)`、`effect TINYINT`、`description VARCHAR(255)`
  - `sys_role_permission`：`role_id BIGINT`、`permission_id BIGINT`（联合唯一）
- 菜单：
  - `sys_menu`：`id BIGINT PK AI`、`parent_id BIGINT NULL`、`menu_type TINYINT`、`menu_name VARCHAR(100)`、`route_path VARCHAR(255)`、`component_path VARCHAR(255)`、`permission_hint VARCHAR(100)`、`icon VARCHAR(100)`、`order_num INT`、`external_link VARCHAR(255)`、`badge_text VARCHAR(20)`、`active_path VARCHAR(255)`、`enabled TINYINT`、`cache_page TINYINT`、`hidden_menu TINYINT`、`embedded TINYINT`、`show_badge TINYINT`、`affix TINYINT`、`hide_tab TINYINT`、`full_screen TINYINT`
  - `sys_role_menu`：`role_id BIGINT`、`menu_id BIGINT`（联合唯一）
  - `sys_menu_permission`（可选）：`menu_id BIGINT`、`permission_id BIGINT`（联合唯一）
- 审计与日志：
  - `sys_oper_log`：记录写操作，含 `id`、`action`、`operator`、`request_uri`、`method`、`ip`、`created_at`、`details`
- 索引：为用户名、角色编码、权限编码、路由路径等建立唯一/普通索引；外键可选软约束（应用层保证）。
- 迁移：使用 Flyway 管理 `V1__init.sql`（建表）与 `V2__seed.sql`（种子数据：管理员用户、基础角色与权限）。

## 后端实现步骤
1. 依赖与配置：引入 `mybatis-plus-boot-starter`、`flyway-core`、`spring-boot-starter-validation`、`spring-boot-starter-jdbc`；配置数据源与 mybatis-plus 全局策略；保留 sa-token。
2. 数据库迁移：编写 `db/migration` 脚本（建表 + 初始数据）。
3. 域模型与 Mapper：为用户、角色、权限、菜单等建立实体与 Mapper（MP），分页统一用 `Page<T>`。
4. 服务层：
   - 认证服务：验证码生成与校验、注册（用户名唯一、密码强度校验、BCrypt 哈希）、登录（校验 + `StpUtil.login(userId)`）、登出、`me` 返回 `UserDto`（含角色与权限）。
   - 用户服务：CRUD、状态修改、重置密码（BCrypt）、分配角色、导入/导出。
   - 角色服务：CRUD、分配菜单、分配权限；返回 `RoleBrief`；聚合权限集合用于 `UserDto.permissions`。
   - 菜单服务：树查询与 CRUD；可选绑定权限。
   - 权限服务：CRUD。
5. 控制器：按接口约定实现，参数校验 `@Valid`，分页/查询条件解析；统一异常处理与响应包装。
6. 鉴权与权限注解：
   - 登录/注册/验证码接口放行；其余接口使用 `@SaCheckPermission`。
   - 为管理接口绑定权限码（如 `sys:user:list` 等）。
7. 审计：操作日志 AOP 切面记录写操作到 `sys_oper_log`。

## 前端实现步骤
1. 契约统一与拦截器：Axios 将令牌设置到 `satoken` 头；后续支持 `Authorization: Bearer`；统一错误处理（401 跳转登录，403 提示无权限）。
2. 登录/注册页面：
   - 登录：输入账号/密码/验证码，调用 `/api/auth/login`，保存 `token` 与用户信息。
   - 验证码：页面加载调用 `/api/auth/captcha`，展示图片或算式，提交时携带 `captchaToken/captchaCode`。
   - 注册：`/api/auth/register`（可开关），成功后提示并跳转登录。
3. 布局与路由：基于 Ant Design Pro 的布局；菜单由后端 `sys_menu` 驱动（初期可静态，后续从接口拉取并按权限过滤）。
4. 用户管理页面：
   - 列表分页、查询筛选、详情抽屉、创建/编辑表单、删除确认、重置密码、修改状态、分配角色；与后台接口契约一致。
5. 角色管理页面：
   - 列表分页、详情、创建/编辑、删除、分配菜单树、分配权限（多选）。
6. 权限管理与菜单树：
   - 权限列表页面；菜单树管理页面（拖拽排序可后续增加）。
7. 按钮显隐：基于 `UserDto.permissions` 与 `permissionHint` 控制组件显隐；无权限展示禁用或隐藏。

## 验证与联调
- 后端：跑起 Spring Boot，初始化数据库；通过 Postman 走认证与管理接口流程，确认权限控制与分页正确。
- 前端：`npm run dev` 联调，完成登录、拉取用户/角色数据、进行增删改查；401/403 行为验证。
- E2E 清单：登录成功/失败、验证码过期、注册重复用户名、用户 CRUD、角色 CRUD、分配角色后权限生效、菜单树查询与显隐。

## 交付与后续优化
- 交付：后端依赖与迁移脚本、前端页面与路由、接口契约文档；演示管理员账号与基础数据。
- 优化：统一响应包装、中英文国际化、操作日志查询页面、文件导入/导出优化、`Authorization: Bearer` 兼容、敏感字段加掩码、CSRF 防护、HTTPS。

---
请确认该方案。如果确认，我将开始：
1）后端依赖与 Flyway 迁移脚本落地，完成认证/用户/角色/菜单/权限的持久化与接口；
2）前端页面与拦截器按契约改造，联通并验证完整流程。